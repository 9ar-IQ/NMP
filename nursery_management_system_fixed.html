<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursery Management System</title>
    <script type="text/javascript" src="https://me.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=77KdT19ytfcFqYBHG9MGoCe6qFr9IyxQY4Rf9a4KKm_fcBUu2S46N60_fE-oHcJCs1PxEdgpyRbASPXekDu0ljBBmjFTLom3YfxSqqPhnVoZaZCkKutcUsBzYhoC9DMyBLdMjQU6SkBND0EW9LlCFcnW5Ei6lOSUckoMF2ySyxJjyfOrygYNxHlaX9mzn6Eb2l_dZQsLARYiogGQwy5CfkCZr2_PvmSQCrWscaNMx17mfLAp4Gmv6XByvyTzifneY9qO0nm_WF5QOfObGM5FFSJSd5QQH49IbccLvJN_d83JKYTCtlFTJBxndxw_iAjuecX1ESWPqR2GCvTvOQC_kMIYdToaAGKOG80veuP5AizNr3mpnj4fIN8gfeSQTWnV6RGDNHkD821t_j2JpDtDXEyj-HQAjwUSsvY4AhGTdXw12JkZbQCg0jdKk_9yaTrutTCM5zV2KIt89IWG00Vjk3PUxorlVbTTR87lGGa-5snehHk-lnbMh3E-P0cDmu64mNBrtGycy1hJZkuSCvfabwNWrzhHoilRFdAZggtT5NBjQ8NfLmX3HKz9YMlUs698f7lm_CzFoD_QhV4fXhI1wfZPPgolRT9fPHcQGtLaeEJoR82JUU1IKSPqG_slo1zZR0iK_fM8RiJgFRtmvfIlbDN4TKKnBRaqFM7RKjhR13_2uh8OREPK6JYWd3xOp3AEc_xEZNYWAc4Ic7v0MtbQ0ZfGTh8SMWjc3Aa_TIjcF7WuBSFhw0OLao_r80zgcMvYKSMJmmSkvas5CmpjunMMw05RkS0ZHXIdDhim4xQnSIsGu226NdnCsHkWWzGBy1WBNijVYS2X4z5AvSbKps7Z336mzyYhEYk23Zj6vDTfqkaZ-5D5bhdPEmMu3XoU-mIEGTHmnazixpdtBQ5jemDz6Xs0EdOYH1f-YpB__MwUDS4WZ1en0U22xDRJTqEowNL9" charset="UTF-8"></script><link rel="stylesheet" crossorigin="anonymous" href="https://me.kis.v2.scr.kaspersky-labs.com/E3E8934C-235A-4B0E-825A-35A08381A191/abn/main.css?attr=aHR0cHM6Ly92aWRhLXByaXZhdGUuczMudXMtZWFzdC0xLmFtYXpvbmF3cy5jb20vc2Vzc2lvbkZpbGUvbWFEOU9aVmxTNnlWZm9ia1Jma3Boei9zYW5kYm94L0N5aWZ5SzZOTEQ4TExDUnBRZ3pMR1VfMTc0ODA4MDI5NTA5M19uYTFmbl9MMmh2YldVdmRXSjFiblIxTDI1MWNuTmxjbmxmYldGdVlXZGxiV1Z1ZEY5emVYTjBaVzFmWm1sNFpXUS5odG1sP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNvbnRlbnQtU2hhMjU2PVVOU0lHTkVELVBBWUxPQUQmWC1BbXotQ3JlZGVudGlhbD1BS0lBWlYzQTJFQ1pPRkhWVDRVViUyZjIwMjUwNTI0JTJmdXMtZWFzdC0xJTJmczMlMmZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDUyNFQwOTU3MTlaJlgtQW16LUV4cGlyZXM9NjAzODAwJlgtQW16LVNpZ25hdHVyZT0xM2Q2MTNhNTA2YTk0NGEwYTBlNzE5ZjRiMzQ1YWM3ODIwNDgzMmYwMjBhZjM0ZDA1NDkxNTE2NjMxODk1N2EzJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCZyZXNwb25zZS1jb250ZW50LWRpc3Bvc2l0aW9uPWF0dGFjaG1lbnQlM2IlMjBmaWxlbmFtZSUyYSUzZFVURi04JTI3JTI3bnVyc2VyeV9tYW5hZ2VtZW50X3N5c3RlbV9maXhlZC5odG1sJnJlc3BvbnNlLWNvbnRlbnQtdHlwZT10ZXh0JTJmaHRtbCZ4LWFtei1jaGVja3N1bS1tb2RlPUVOQUJMRUQmeC1pZD1HZXRPYmplY3Q"/><style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 100px auto;
            animation: slideIn 0.5s ease-out;
        }

        .main-dashboard {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 30px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .nav-button {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .table th, .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .close-modal {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-hold {
            background: #fff3cd;
            color: #856404;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Student search dropdown */
        .search-dropdown {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 0 0 8px 8px;
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .search-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-item:hover {
            background: #f8f9fa;
        }

        .conditional-field {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <h2 style="text-align: center; margin-bottom: 30px; color: #667eea;">Nursery Management System</h2>
            <div id="loginAlert"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="hidden">
        <div class="container">
            <div class="main-dashboard">
                <div class="header">
                    <div class="logo">üè´ Nursery Management</div>
                    <div class="user-info">
                        <span id="currentUser">Welcome, Admin</span>
                        <button class="btn btn-secondary" onclick="logout()">Logout</button>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div id="dashboardView">
                    <div class="quick-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="totalStudents">0</div>
                            <div class="stat-label">Total Students</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="monthlyIncome">$0</div>
                            <div class="stat-label">Monthly Income</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="monthlyExpenses">$0</div>
                            <div class="stat-label">Monthly Expenses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="activeUsers">0</div>
                            <div class="stat-label">Active Users</div>
                        </div>
                    </div>

                    <div class="nav-menu">
                        <button class="nav-button" onclick="showView('studentsView')">üë• Student Management</button>
                        <button class="nav-button" onclick="showView('expensesView')">üí∞ Expense Management</button>
                        <button class="nav-button" onclick="showView('usersView')" id="userManagementBtn">üë§ User Management</button>
                        <button class="nav-button" onclick="showView('reportsView')">üìä Reports & Analytics</button>
                        <button class="nav-button" onclick="showView('settingsView')">‚öôÔ∏è System Settings</button>
                    </div>
                </div>

                <!-- Students Management View -->
                <div id="studentsView" class="hidden">
                    <div class="header">
                        <h2>Student Management</h2>
                        <div>
                            <button class="btn btn-success" onclick="showModal('addStudentModal')">Add New Student</button>
                            <button class="btn btn-secondary" onclick="showView('dashboardView')">Back to Dashboard</button>
                        </div>
                    </div>
                    <div id="studentsAlert"></div>
                    <table class="table" id="studentsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Class</th>
                                <th>Join Date</th>
                                <th>Birthday</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Expenses Management View -->
                <div id="expensesView" class="hidden">
                    <div class="header">
                        <h2>Expense Management</h2>
                        <div>
                            <button class="btn btn-success" onclick="showModal('addExpenseModal')">Add New Transaction</button>
                            <button class="btn btn-secondary" onclick="showView('dashboardView')">Back to Dashboard</button>
                        </div>
                    </div>
                    <div id="expensesAlert"></div>
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div>
                            <label>Filter by Date Range:</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="date" id="expenseFromDate">
                                <input type="date" id="expenseToDate">
                                <button class="btn btn-primary" onclick="filterExpenses()">Filter</button>
                            </div>
                        </div>
                        <div>
                            <label>Filter by Type:</label>
                            <select id="expenseTypeFilter" onchange="filterExpenses()">
                                <option value="">All Types</option>
                                <option value="Student Subscription">Student Subscription</option>
                                <option value="Meals Subscription">Meals Subscription</option>
                                <option value="Late Club">Late Club</option>
                                <option value="Bus">Bus</option>
                                <option value="Activity Club">Activity Club</option>
                                <option value="Hospitality">Hospitality</option>
                                <option value="Cleaning">Cleaning</option>
                                <option value="Electricity">Electricity</option>
                                <option value="Learning Tools">Learning Tools</option>
                            </select>
                        </div>
                    </div>
                    <table class="table" id="expensesTable">
                        <thead>
                            <tr>
                                <th>Reference</th>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Payment Method</th>
                                <th>In/Out</th>
                                <th>Source/Allocation</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Users Management View -->
                <div id="usersView" class="hidden">
                    <div class="header">
                        <h2>User Management</h2>
                        <div>
                            <button class="btn btn-success" onclick="showModal('addUserModal')">Add New User</button>
                            <button class="btn btn-secondary" onclick="showView('dashboardView')">Back to Dashboard</button>
                        </div>
                    </div>
                    <div id="usersAlert"></div>
                    <table class="table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Created Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Reports View -->
                <div id="reportsView" class="hidden">
                    <div class="header">
                        <h2>Reports & Analytics</h2>
                        <button class="btn btn-secondary" onclick="showView('dashboardView')">Back to Dashboard</button>
                    </div>
                    <div class="form-row" style="margin-bottom: 30px;">
                        <div class="form-group">
                            <label>From Date:</label>
                            <input type="date" id="reportFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date:</label>
                            <input type="date" id="reportToDate">
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                        <button class="btn btn-success" onclick="exportToExcel()">Export to Excel</button>
                    </div>
                    <div id="reportsAlert"></div>
                    <div id="reportContent" style="margin-top: 30px;"></div>
                </div>

                <!-- Settings View -->
                <div id="settingsView" class="hidden">
                    <div class="header">
                        <h2>System Settings</h2>
                        <button class="btn btn-secondary" onclick="showView('dashboardView')">Back to Dashboard</button>
                    </div>
                    <div id="settingsAlert"></div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Closing Period Date:</label>
                            <input type="date" id="closingPeriodDate">
                            <button class="btn btn-primary" onclick="updateClosingPeriod()" style="margin-top: 10px;">Update</button>
                        </div>
                        <div class="form-group">
                            <label>Data Backup:</label>
                            <p style="margin-bottom: 10px;">Last backup: <span id="lastBackup">Never</span></p>
                            <button class="btn btn-primary" onclick="backupData()">Backup Now</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addStudentModal')">&times;</span>
            <h3>Add New Student</h3>
            <form id="addStudentForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input type="text" name="lastName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Birthday</label>
                        <input type="date" name="birthday">
                    </div>
                    <div class="form-group">
                        <label>Join Date *</label>
                        <input type="date" name="joinDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Class *</label>
                    <select name="class" required>
                        <option value="">Select Class</option>
                        <option value="Nursery 1">Nursery 1</option>
                        <option value="Nursery 2">Nursery 2</option>
                        <option value="KG 1">KG 1</option>
                        <option value="KG 2">KG 2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Allergic Notes</label>
                    <textarea name="allergicNotes" rows="3" placeholder="Any allergies or special notes..."></textarea>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="Active">Active</option>
                        <option value="On Hold">On Hold</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Add Student</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addStudentModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addExpenseModal')">&times;</span>
            <h3>Add New Transaction</h3>
            <form id="addExpenseForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Reference Number *</label>
                        <input type="text" name="reference" required>
                    </div>
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" name="date" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type of Transaction *</label>
                        <select name="type" required id="transactionType">
                            <option value="">Select Type</option>
                            <option value="Student Subscription">Student Subscription</option>
                            <option value="Meals Subscription">Meals Subscription</option>
                            <option value="Late Club">Late Club</option>
                            <option value="Bus">Bus</option>
                            <option value="Activity Club">Activity Club</option>
                            <option value="Hospitality">Hospitality</option>
                            <option value="Cleaning">Cleaning</option>
                            <option value="Electricity">Electricity</option>
                            <option value="Learning Tools">Learning Tools</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount *</label>
                        <input type="number" name="amount" step="0.01" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Payment Method *</label>
                        <select name="paymentMethod" required>
                            <option value="">Select Method</option>
                            <option value="Cash">Cash</option>
                            <option value="POS">POS</option>
                            <option value="Debit">Debit</option>
                            <option value="Credit">Credit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Transaction Type *</label>
                        <select name="inOut" required id="inOutSelect">
                            <option value="">Select Type</option>
                            <option value="In">Income</option>
                            <option value="Out">Expense</option>
                        </select>
                    </div>
                </div>
                
                <!-- Income Source Selection (conditionally shown) -->
                <div id="incomeSourceContainer" class="conditional-field hidden">
                    <div class="form-group">
                        <label>Income Source *</label>
                        <select name="incomeSource" id="incomeSourceSelect">
                            <option value="">Select Source</option>
                            <option value="Student">Student</option>
                            <option value="Bank">From Bank</option>
                            <option value="Staff">Staff Advance</option>
                            <option value="Other">Others</option>
                        </select>
                    </div>
                    
                    <!-- Student Search (conditionally shown) -->
                    <div id="studentSearchContainer" class="conditional-field hidden">
                        <div class="form-group search-dropdown">
                            <label>Search Student *</label>
                            <input type="text" id="studentSearch" placeholder="Type student name..." autocomplete="off">
                            <input type="hidden" id="selectedStudentId" name="studentId">
                            <div id="searchResults" class="search-results hidden"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Expense Allocation Selection (conditionally shown) -->
                <div id="expenseAllocationContainer" class="conditional-field hidden">
                    <div class="form-group">
                        <label>Expense Allocation *</label>
                        <select name="expenseAllocation" id="expenseAllocationSelect">
                            <option value="">Select Allocation</option>
                            <option value="Salaries">Salaries</option>
                            <option value="Rent">Rent</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Supplies">Supplies</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Food">Food</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Taxes">Taxes</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="3" placeholder="Additional notes..."></textarea>
                </div>
                <button type="submit" class="btn btn-success">Add Transaction</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addExpenseModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addUserModal')">&times;</span>
            <h3>Add New User</h3>
            <form id="addUserForm">
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" name="password" required>
                </div>
                <div class="form-group">
                    <label>Confirm Password *</label>
                    <input type="password" name="confirmPassword" required>
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select name="role" required>
                        <option value="">Select Role</option>
                        <option value="Admin">Admin</option>
                        <option value="Logger">Logger</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="Active">Active</option>
                        <option value="On Hold">On Hold</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Add User</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addUserModal')">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        // Application State
        let currentUser = null;
        let users = [
            { id: 1, username: 'admin', password: 'admin123', role: 'Admin', status: 'Active', createdDate: '2024-01-01' }
        ];
        let students = [];
        let expenses = [];
        let closingPeriodDate = null;

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            loadSampleData();
            updateDashboardStats();
            
            // Set up event listeners for conditional fields
            document.getElementById('inOutSelect').addEventListener('change', toggleSourceAllocationFields);
            document.getElementById('incomeSourceSelect').addEventListener('change', toggleStudentSearch);
            
            // Set up student search functionality
            const studentSearchInput = document.getElementById('studentSearch');
            studentSearchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                if (searchTerm.length < 2) {
                    document.getElementById('searchResults').classList.add('hidden');
                    return;
                }
                
                const filteredStudents = students.filter(student => 
                    `${student.firstName} ${student.lastName}`.toLowerCase().includes(searchTerm)
                );
                
                const resultsContainer = document.getElementById('searchResults');
                resultsContainer.innerHTML = '';
                
                if (filteredStudents.length > 0) {
                    filteredStudents.forEach(student => {
                        const item = document.createElement('div');
                        item.className = 'search-item';
                        item.textContent = `${student.firstName} ${student.lastName} (${student.class})`;
                        item.addEventListener('click', function() {
                            document.getElementById('selectedStudentId').value = student.id;
                            studentSearchInput.value = `${student.firstName} ${student.lastName}`;
                            resultsContainer.classList.add('hidden');
                        });
                        resultsContainer.appendChild(item);
                    });
                    resultsContainer.classList.remove('hidden');
                } else {
                    resultsContainer.classList.add('hidden');
                }
            });
            
            // Hide search results when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-dropdown')) {
                    document.getElementById('searchResults').classList.add('hidden');
                }
            });
            
            // Initialize form event listeners
            document.getElementById('addUserForm').addEventListener('submit', handleAddUserSubmit);
            document.getElementById('addStudentForm').addEventListener('submit', handleAddStudentSubmit);
            document.getElementById('addExpenseForm').addEventListener('submit', handleAddExpenseSubmit);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        });

        // Toggle source/allocation fields based on transaction type
        function toggleSourceAllocationFields() {
            const transactionType = document.getElementById('inOutSelect').value;
            const incomeSourceContainer = document.getElementById('incomeSourceContainer');
            const expenseAllocationContainer = document.getElementById('expenseAllocationContainer');
            
            if (transactionType === 'In') {
                incomeSourceContainer.classList.remove('hidden');
                expenseAllocationContainer.classList.add('hidden');
                // Reset expense allocation
                document.getElementById('expenseAllocationSelect').value = '';
            } else if (transactionType === 'Out') {
                incomeSourceContainer.classList.add('hidden');
                expenseAllocationContainer.classList.remove('hidden');
                // Reset income source and student search
                document.getElementById('incomeSourceSelect').value = '';
                document.getElementById('studentSearchContainer').classList.add('hidden');
                document.getElementById('studentSearch').value = '';
                document.getElementById('selectedStudentId').value = '';
            } else {
                incomeSourceContainer.classList.add('hidden');
                expenseAllocationContainer.classList.add('hidden');
            }
        }
        
        // Toggle student search based on income source
        function toggleStudentSearch() {
            const incomeSource = document.getElementById('incomeSourceSelect').value;
            const studentSearchContainer = document.getElementById('studentSearchContainer');
            
            if (incomeSource === 'Student') {
                studentSearchContainer.classList.remove('hidden');
            } else {
                studentSearchContainer.classList.add('hidden');
                document.getElementById('studentSearch').value = '';
                document.getElementById('selectedStudentId').value = '';
            }
        }

        // Sample Data
        function loadSampleData() {
            students = [
                { id: 1, firstName: 'John', lastName: 'Doe', birthday: '2020-05-15', joinDate: '2024-01-10', class: 'Nursery 1', allergicNotes: 'None', status: 'Active' },
                { id: 2, firstName: 'Sarah', lastName: 'Smith', birthday: '2019-08-22', joinDate: '2024-01-15', class: 'KG 1', allergicNotes: 'Peanut allergy', status: 'Active' },
                { id: 3, firstName: 'Mike', lastName: 'Johnson', birthday: '2020-12-03', joinDate: '2024-02-01', class: 'Nursery 2', allergicNotes: 'None', status: 'On Hold' }
            ];

            expenses = [
                { id: 1, reference: 'REF001', date: '2024-05-01', type: 'Student Subscription', amount: 500, paymentMethod: 'Cash', inOut: 'In', description: 'Monthly fee', source: 'Student', studentId: 1 },
                { id: 2, reference: 'REF002', date: '2024-05-02', type: 'Cleaning', amount: 150, paymentMethod: 'Cash', inOut: 'Out', description: 'Cleaning supplies', allocation: 'Supplies' },
                { id: 3, reference: 'REF003', date: '2024-05-03', type: 'Meals Subscription', amount: 200, paymentMethod: 'POS', inOut: 'In', description: 'Meal plan', source: 'Bank' }
            ];
        }

        // Authentication
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = users.find(u => u.username === username && u.password === password && u.status === 'Active');
            
            if (user) {
                currentUser = user;
                document.getElementById('currentUser').textContent = `Welcome, ${user.username} (${user.role})`;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainDashboard').classList.remove('hidden');
                
                // Hide user management for non-admin users
                if (user.role !== 'Admin') {
                    document.getElementById('userManagementBtn').style.display = 'none';
                }
                
                updateDashboardStats();
                showAlert('loginAlert', 'Login successful!', 'success');
            } else {
                showAlert('loginAlert', 'Invalid username or password!', 'error');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainDashboard').classList.add('hidden');
            document.getElementById('loginForm').reset();
            showView('dashboardView');
        }

        // Navigation
        function showView(viewId) {
            const views = ['dashboardView', 'studentsView', 'expensesView', 'usersView', 'reportsView', 'settingsView'];
            views.forEach(view => {
                document.getElementById(view).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
            
            if (viewId === 'studentsView') loadStudentsTable();
            if (viewId === 'expensesView') loadExpensesTable();
            if (viewId === 'usersView') loadUsersTable();
        }

        // Modal Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            
            // Reset form when modal is closed
            const modal = document.getElementById(modalId);
            const form = modal.querySelector('form');
            if (form) {
                form.reset();
                form.removeAttribute('data-edit-id');
                // Reset form titles and button text
                const modalTitle = modal.querySelector('h3');
                const submitBtn = modal.querySelector('button[type="submit"]');
                if (modalId === 'addStudentModal') {
                    modalTitle.textContent = 'Add New Student';
                    submitBtn.textContent = 'Add Student';
                } else if (modalId === 'addExpenseModal') {
                    modalTitle.textContent = 'Add New Transaction';
                    submitBtn.textContent = 'Add Transaction';
                    // Reset conditional fields
                    document.getElementById('incomeSourceContainer').classList.add('hidden');
                    document.getElementById('expenseAllocationContainer').classList.add('hidden');
                    document.getElementById('studentSearchContainer').classList.add('hidden');
                } else if (modalId === 'addUserModal') {
                    modalTitle.textContent = 'Add New User';
                    submitBtn.textContent = 'Add User';
                }
            }
        }

        // Alert Functions
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Dashboard Stats
        function updateDashboardStats() {
            document.getElementById('totalStudents').textContent = students.filter(s => s.status === 'Active').length;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyIncome = expenses
                .filter(e => e.inOut === 'In' && new Date(e.date).getMonth() === currentMonth && new Date(e.date).getFullYear() === currentYear)
                .reduce((sum, e) => sum + parseFloat(e.amount), 0);
            
            const monthlyExpenseAmount = expenses
                .filter(e => e.inOut === 'Out' && new Date(e.date).getMonth() === currentMonth && new Date(e.date).getFullYear() === currentYear)
                .reduce((sum, e) => sum + parseFloat(e.amount), 0);
            
            document.getElementById('monthlyIncome').textContent = `$${monthlyIncome.toFixed(2)}`;
            document.getElementById('monthlyExpenses').textContent = `$${monthlyExpenseAmount.toFixed(2)}`;
            document.getElementById('activeUsers').textContent = users.filter(u => u.status === 'Active').length;
        }

        // Student Management
        function loadStudentsTable() {
            const tbody = document.querySelector('#studentsTable tbody');
            tbody.innerHTML = '';
            
            students.forEach(student => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${student.class}</td>
                    <td>${student.joinDate}</td>
                    <td>${student.birthday}</td>
                    <td><span class="status-badge status-${student.status.toLowerCase().replace(' ', '-')}">${student.status}</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="editStudent(${student.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteStudent(${student.id})">Delete</button>
                    </td>
                `;
            });
        }

        function handleAddStudentSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const editId = e.target.getAttribute('data-edit-id');
            
            const studentData = {
                id: editId ? parseInt(editId) : Date.now(),
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                birthday: formData.get('birthday'),
                joinDate: formData.get('joinDate'),
                class: formData.get('class'),
                allergicNotes: formData.get('allergicNotes'),
                status: formData.get('status')
            };
            
            if (editId) {
                // Update existing student
                const studentIndex = students.findIndex(s => s.id === parseInt(editId));
                if (studentIndex !== -1) {
                    students[studentIndex] = studentData;
                }
                e.target.removeAttribute('data-edit-id');
                document.querySelector('#addStudentModal h3').textContent = 'Add New Student';
                document.querySelector('#addStudentModal button[type="submit"]').textContent = 'Add Student';
                showAlert('studentsAlert', 'Student updated successfully!', 'success');
            } else {
                // Add new student
                students.push(studentData);
                showAlert('studentsAlert', 'Student added successfully!', 'success');
            }
            
            loadStudentsTable();
            updateDashboardStats();
            hideModal('addStudentModal');
            e.target.reset();
        }

        function editStudent(id) {
            const student = students.find(s => s.id === id);
            if (student) {
                // Pre-fill form with student data
                const form = document.getElementById('addStudentForm');
                form.elements.firstName.value = student.firstName;
                form.elements.lastName.value = student.lastName;
                form.elements.birthday.value = student.birthday;
                form.elements.joinDate.value = student.joinDate;
                form.elements.class.value = student.class;
                form.elements.allergicNotes.value = student.allergicNotes;
                form.elements.status.value = student.status;
                
                form.setAttribute('data-edit-id', id);
                document.querySelector('#addStudentModal h3').textContent = 'Edit Student';
                document.querySelector('#addStudentModal button[type="submit"]').textContent = 'Update Student';
                
                showModal('addStudentModal');
            }
        }

        function deleteStudent(id) {
            if (confirm('Are you sure you want to delete this student?')) {
                students = students.filter(s => s.id !== id);
                loadStudentsTable();
                updateDashboardStats();
                showAlert('studentsAlert', 'Student deleted successfully!', 'success');
            }
        }

        // Expense Management
        function loadExpensesTable(filteredData = null) {
            const tbody = document.querySelector('#expensesTable tbody');
            tbody.innerHTML = '';
            
            const data = filteredData || expenses;
            
            data.forEach(expense => {
                const row = tbody.insertRow();
                
                // Get source/allocation information
                let sourceAllocation = '';
                if (expense.inOut === 'In') {
                    if (expense.source === 'Student' && expense.studentId) {
                        const student = students.find(s => s.id === expense.studentId);
                        sourceAllocation = student ? `${student.firstName} ${student.lastName}` : 'Unknown Student';
                    } else {
                        sourceAllocation = expense.source || '';
                    }
                } else {
                    sourceAllocation = expense.allocation || '';
                }
                
                row.innerHTML = `
                    <td>${expense.reference}</td>
                    <td>${expense.date}</td>
                    <td>${expense.type}</td>
                    <td>${parseFloat(expense.amount).toFixed(2)}</td>
                    <td>${expense.paymentMethod}</td>
                    <td><span style="color: ${expense.inOut === 'In' ? 'green' : 'red'}">${expense.inOut}</span></td>
                    <td>${sourceAllocation}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editExpense(${expense.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteExpense(${expense.id})">Delete</button>
                    </td>
                `;
            });
        }

        function handleAddExpenseSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const editId = e.target.getAttribute('data-edit-id');
            
            // Get basic transaction data
            const transactionData = {
                id: editId ? parseInt(editId) : Date.now(),
                reference: formData.get('reference'),
                date: formData.get('date'),
                type: formData.get('type'),
                amount: parseFloat(formData.get('amount')),
                paymentMethod: formData.get('paymentMethod'),
                inOut: formData.get('inOut'),
                description: formData.get('description')
            };
            
            // Add source/allocation based on transaction type
            if (transactionData.inOut === 'In') {
                transactionData.source = formData.get('incomeSource');
                if (transactionData.source === 'Student') {
                    transactionData.studentId = parseInt(document.getElementById('selectedStudentId').value);
                }
            } else if (transactionData.inOut === 'Out') {
                transactionData.allocation = formData.get('expenseAllocation');
            }
            
            if (editId) {
                // Update existing expense
                const expenseIndex = expenses.findIndex(e => e.id === parseInt(editId));
                if (expenseIndex !== -1) {
                    expenses[expenseIndex] = transactionData;
                }
                e.target.removeAttribute('data-edit-id');
                document.querySelector('#addExpenseModal h3').textContent = 'Add New Transaction';
                document.querySelector('#addExpenseModal button[type="submit"]').textContent = 'Add Transaction';
                showAlert('expensesAlert', 'Transaction updated successfully!', 'success');
            } else {
                // Add new expense
                expenses.push(transactionData);
                showAlert('expensesAlert', 'Transaction added successfully!', 'success');
            }
            
            loadExpensesTable();
            updateDashboardStats();
            hideModal('addExpenseModal');
            e.target.reset();
            
            // Reset conditional fields
            document.getElementById('incomeSourceContainer').classList.add('hidden');
            document.getElementById('expenseAllocationContainer').classList.add('hidden');
            document.getElementById('studentSearchContainer').classList.add('hidden');
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                const form = document.getElementById('addExpenseForm');
                form.elements.reference.value = expense.reference;
                form.elements.date.value = expense.date;
                form.elements.type.value = expense.type;
                form.elements.amount.value = expense.amount;
                form.elements.paymentMethod.value = expense.paymentMethod;
                form.elements.inOut.value = expense.inOut;
                form.elements.description.value = expense.description || '';
                
                // Handle conditional fields
                if (expense.inOut === 'In') {
                    document.getElementById('incomeSourceContainer').classList.remove('hidden');
                    document.getElementById('expenseAllocationContainer').classList.add('hidden');
                    
                    if (expense.source) {
                        document.getElementById('incomeSourceSelect').value = expense.source;
                        
                        if (expense.source === 'Student' && expense.studentId) {
                            document.getElementById('studentSearchContainer').classList.remove('hidden');
                            const student = students.find(s => s.id === expense.studentId);
                            if (student) {
                                document.getElementById('studentSearch').value = `${student.firstName} ${student.lastName}`;
                                document.getElementById('selectedStudentId').value = student.id;
                            }
                        }
                    }
                } else if (expense.inOut === 'Out') {
                    document.getElementById('incomeSourceContainer').classList.add('hidden');
                    document.getElementById('studentSearchContainer').classList.add('hidden');
                    document.getElementById('expenseAllocationContainer').classList.remove('hidden');
                    
                    if (expense.allocation) {
                        document.getElementById('expenseAllocationSelect').value = expense.allocation;
                    }
                }
                
                form.setAttribute('data-edit-id', id);
                document.querySelector('#addExpenseModal h3').textContent = 'Edit Transaction';
                document.querySelector('#addExpenseModal button[type="submit"]').textContent = 'Update Transaction';
                
                showModal('addExpenseModal');
            }
        }

        function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                expenses = expenses.filter(e => e.id !== id);
                loadExpensesTable();
                updateDashboardStats();
                showAlert('expensesAlert', 'Transaction deleted successfully!', 'success');
            }
        }

        function filterExpenses() {
            const fromDate = document.getElementById('expenseFromDate').value;
            const toDate = document.getElementById('expenseToDate').value;
            const type = document.getElementById('expenseTypeFilter').value;
            
            let filteredData = expenses;
            
            if (fromDate) {
                filteredData = filteredData.filter(e => e.date >= fromDate);
            }
            
            if (toDate) {
                filteredData = filteredData.filter(e => e.date <= toDate);
            }
            
            if (type) {
                filteredData = filteredData.filter(e => e.type === type);
            }
            
            loadExpensesTable(filteredData);
        }

        // User Management
        function loadUsersTable() {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.role}</td>
                    <td><span class="status-badge status-${user.status.toLowerCase().replace(' ', '-')}">${user.status}</span></td>
                    <td>${user.createdDate}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editUser(${user.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                        <button class="btn btn-secondary" onclick="toggleUserStatus(${user.id})">${user.status === 'Active' ? 'Deactivate' : 'Activate'}</button>
                    </td>
                `;
            });
        }

        function handleAddUserSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // Validate password match
            const password = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');
            
            if (password !== confirmPassword) {
                showAlert('usersAlert', 'Passwords do not match!', 'error');
                return;
            }
            
            // Check if username already exists
            const username = formData.get('username');
            const editId = e.target.getAttribute('data-edit-id');
            
            if (!editId && users.find(u => u.username === username)) {
                showAlert('usersAlert', 'Username already exists!', 'error');
                return;
            }
            
            if (editId) {
                // Update existing user
                const userIndex = users.findIndex(u => u.id === parseInt(editId));
                if (userIndex !== -1) {
                    users[userIndex] = {
                        ...users[userIndex],
                        username: username,
                        password: password,
                        role: formData.get('role'),
                        status: formData.get('status')
                    };
                }
                e.target.removeAttribute('data-edit-id');
                document.querySelector('#addUserModal h3').textContent = 'Add New User';
                document.querySelector('#addUserModal button[type="submit"]').textContent = 'Add User';
                showAlert('usersAlert', 'User updated successfully!', 'success');
            } else {
                // Add new user
                const userData = {
                    id: Date.now(),
                    username: username,
                    password: password,
                    role: formData.get('role'),
                    status: formData.get('status'),
                    createdDate: new Date().toISOString().split('T')[0]
                };
                users.push(userData);
                showAlert('usersAlert', 'User added successfully!', 'success');
            }
            
            loadUsersTable();
            updateDashboardStats();
            hideModal('addUserModal');
            e.target.reset();
        }

        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                const form = document.getElementById('addUserForm');
                form.elements.username.value = user.username;
                form.elements.password.value = user.password;
                form.elements.confirmPassword.value = user.password;
                form.elements.role.value = user.role;
                form.elements.status.value = user.status;
                
                form.setAttribute('data-edit-id', id);
                document.querySelector('#addUserModal h3').textContent = 'Edit User';
                document.querySelector('#addUserModal button[type="submit"]').textContent = 'Update User';
                
                showModal('addUserModal');
            }
        }

        function deleteUser(id) {
            if (id === 1) {
                showAlert('usersAlert', 'Cannot delete the main admin user!', 'error');
                return;
            }
            if (confirm('Are you sure you want to delete this user?')) {
                users = users.filter(u => u.id !== id);
                loadUsersTable();
                updateDashboardStats();
                showAlert('usersAlert', 'User deleted successfully!', 'success');
            }
        }

        function toggleUserStatus(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                user.status = user.status === 'Active' ? 'On Hold' : 'Active';
                loadUsersTable();
                updateDashboardStats();
                showAlert('usersAlert', `User status changed to ${user.status}!`, 'success');
            }
        }

        // Reports
        function generateReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            
            if (!fromDate || !toDate) {
                showAlert('reportsAlert', 'Please select both from and to dates!', 'error');
                return;
            }
            
            const filteredExpenses = expenses.filter(e => e.date >= fromDate && e.date <= toDate);
            
            const totalIncome = filteredExpenses.filter(e => e.inOut === 'In').reduce((sum, e) => sum + parseFloat(e.amount), 0);
            const totalExpenses = filteredExpenses.filter(e => e.inOut === 'Out').reduce((sum, e) => sum + parseFloat(e.amount), 0);
            const netProfit = totalIncome - totalExpenses;
            
            const reportContent = document.getElementById('reportContent');
            reportContent.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>Financial Report (${fromDate} to ${toDate})</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
                        <div style="text-align: center;">
                            <h4 style="color: green;">Total Income</h4>
                            <p style="font-size: 24px; font-weight: bold;">${totalIncome.toFixed(2)}</p>
                        </div>
                        <div style="text-align: center;">
                            <h4 style="color: red;">Total Expenses</h4>
                            <p style="font-size: 24px; font-weight: bold;">${totalExpenses.toFixed(2)}</p>
                        </div>
                        <div style="text-align: center;">
                            <h4 style="color: ${netProfit >= 0 ? 'green' : 'red'};">Net Profit</h4>
                            <p style="font-size: 24px; font-weight: bold;">${netProfit.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Reference</th>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>In/Out</th>
                            <th>Source/Allocation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredExpenses.map(expense => {
                            // Get source/allocation information
                            let sourceAllocation = '';
                            if (expense.inOut === 'In') {
                                if (expense.source === 'Student' && expense.studentId) {
                                    const student = students.find(s => s.id === expense.studentId);
                                    sourceAllocation = student ? `${student.firstName} ${student.lastName}` : 'Unknown Student';
                                } else {
                                    sourceAllocation = expense.source || '';
                                }
                            } else {
                                sourceAllocation = expense.allocation || '';
                            }
                            
                            return `
                                <tr>
                                    <td>${expense.reference}</td>
                                    <td>${expense.date}</td>
                                    <td>${expense.type}</td>
                                    <td>${parseFloat(expense.amount).toFixed(2)}</td>
                                    <td>${expense.paymentMethod}</td>
                                    <td><span style="color: ${expense.inOut === 'In' ? 'green' : 'red'}">${expense.inOut}</span></td>
                                    <td>${sourceAllocation}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function exportToExcel() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            
            if (!fromDate || !toDate) {
                showAlert('reportsAlert', 'Please generate a report first!', 'error');
                return;
            }
            
            const filteredExpenses = expenses.filter(e => e.date >= fromDate && e.date <= toDate);
            
            let csvContent = "Reference,Date,Type,Amount,Payment Method,In/Out,Source/Allocation,Description\n";
            filteredExpenses.forEach(expense => {
                // Get source/allocation information
                let sourceAllocation = '';
                if (expense.inOut === 'In') {
                    if (expense.source === 'Student' && expense.studentId) {
                        const student = students.find(s => s.id === expense.studentId);
                        sourceAllocation = student ? `${student.firstName} ${student.lastName}` : 'Unknown Student';
                    } else {
                        sourceAllocation = expense.source || '';
                    }
                } else {
                    sourceAllocation = expense.allocation || '';
                }
                
                csvContent += `${expense.reference},${expense.date},${expense.type},${expense.amount},${expense.paymentMethod},${expense.inOut},"${sourceAllocation}","${expense.description || ''}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `nursery_report_${fromDate}_to_${toDate}.csv`;
            link.click();
            window.URL.revokeObjectURL(url);
        }

        // Settings
        function updateClosingPeriod() {
            const date = document.getElementById('closingPeriodDate').value;
            if (date) {
                closingPeriodDate = date;
                showAlert('settingsAlert', 'Closing period updated successfully!', 'success');
            }
        }

        function backupData() {
            const data = {
                users: users,
                students: students,
                expenses: expenses,
                closingPeriodDate: closingPeriodDate,
                backupDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `nursery_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            window.URL.revokeObjectURL(url);
            
            document.getElementById('lastBackup').textContent = new Date().toLocaleString();
            showAlert('settingsAlert', 'Data backup completed successfully!', 'success');
        }
    </script>
</body>
</html>
